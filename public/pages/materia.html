<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Matéria | Revista do Empreendedor Jovem</title>

    <link rel="stylesheet" href="/css/style.css" />

    <meta
      name="description"
      content="Revista do Empreendedor Jovem — notícias sobre tecnologia, economia, empreendedorismo, bolsas e cursos."
    />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="Davi H. do Amaral" />

    <!-- Favicon -->
    <link rel="icon" href="/favicon/favicon.ico" sizes="any" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="apple-touch-icon" href="/favicon/apple-touch-icon.png" />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <meta name="theme-color" content="#ffffff" />

    <style>
      .materia-wrap { max-width: 900px; margin: 24px auto; padding: 0 16px; }
      .materia-top { display:flex; justify-content:space-between; align-items:baseline; gap:16px; margin-bottom:12px; }
      .materia-top a { color: inherit; text-decoration:none; }
      .materia-top a:hover { text-decoration:underline; }

      .meta { color:#666; font-size:14px; margin:8px 0 14px; text-transform:capitalize; }
      .hero { width:100%; max-height:380px; object-fit:cover; border:1px solid #ddd; margin:14px 0 18px; }
      .titulo { margin:10px 0 8px; font-size:34px; line-height:1.1; }
      .resumo { font-size:18px; color:#222; margin:0 0 12px; }
      .conteudo { font-size:18px; line-height:1.7; color:#111; white-space:pre-wrap; }
      .status { margin-top:18px; color:#b00020; }
      .muted { color:#666; }
      .hr { border:none; border-top:1px solid #ddd; margin:18px 0; }
    </style>
  </head>

  <body data-page="materia">
    <div class="materia-wrap">
      <div class="materia-top">
        <a href="/" class="muted">← Voltar para a Home</a>
        <span class="muted" id="now"></span>
      </div>

      <article id="materia">
        <p class="muted">Carregando matéria...</p>
      </article>

      <p id="status" class="status"></p>
    </div>

    <!-- ✅ precisa existir pra padronizar fetch (prod/dev/tunnel) -->
    <script src="/js/config.js"></script>

    <!-- ✅ sistema de anúncios (não pode quebrar a matéria se falhar) -->
    <script src="/js/ads.js"></script>

    <script>
      const materiaEl = document.getElementById("materia");
      const statusEl = document.getElementById("status");
      const nowEl = document.getElementById("now");

      const API_BASE = (window.API_BASE ?? "").replace(/\/$/, ""); // remove barra final

      function escapeHtml(str) {
        return String(str ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function formatDate(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        return d.toLocaleString("pt-BR", {
          day: "2-digit",
          month: "long",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function getIdFromUrl() {
        const id = Number(new URL(window.location.href).searchParams.get("id"));
        return Number.isInteger(id) ? id : null;
      }

      async function carregar() {
        // data no topo
        if (nowEl) {
          const now = new Date();
          nowEl.textContent = now.toLocaleDateString("pt-BR", {
            weekday: "long",
            day: "2-digit",
            month: "long",
            year: "numeric",
          });
        }

        const id = getIdFromUrl();
        if (!id) {
          materiaEl.innerHTML =
            '<p>URL inválida. Falta o parâmetro <strong>?id=</strong>.</p>';
          return;
        }

        try {
          const url = `${API_BASE}/api/noticias/${id}`;
          const res = await fetch(url, { headers: { Accept: "application/json" } });

          const noticia = await res.json().catch(() => null);

          if (!res.ok || !noticia) {
            statusEl.textContent = noticia?.error || "Erro ao carregar a matéria.";
            materiaEl.innerHTML = "<p>Não foi possível carregar a matéria.</p>";
            return;
          }

          const titulo = escapeHtml(noticia.titulo);
          const resumo = escapeHtml(noticia.resumo);
          const conteudo = escapeHtml(noticia.conteudo);
          const categoria = escapeHtml(noticia.categoria);
          const dt = escapeHtml(formatDate(noticia.created_at));

          // SEO dinâmico
          document.title = `${titulo} | Revista do Empreendedor Jovem`;
          const metaDesc = document.querySelector('meta[name="description"]');
          if (metaDesc) metaDesc.setAttribute("content", noticia.resumo || "");

          materiaEl.innerHTML = `
            <div class="meta">${categoria} • ${dt}</div>
            <h1 class="titulo">${titulo}</h1>
            <p class="resumo">${resumo}</p>

            <!-- SLOT: anúncio topo -->
            <div id="ad_materia_topo"></div>

            ${noticia.imagem ? `<img class="hero" src="${noticia.imagem}" alt="${titulo}">` : ""}

            <hr class="hr" />

            <div class="conteudo">${conteudo}</div>

            <!-- SLOT: anúncio rodapé -->
            <div id="ad_materia_rodape"></div>
          `;

          // ✅ só tenta carregar anúncio se a função existir
          if (typeof window.loadAd === "function") {
            try {
              window.loadAd("ad_materia_topo", { slot: "materia_topo", categoria: noticia.categoria });
              window.loadAd("ad_materia_rodape", { slot: "materia_rodape", categoria: noticia.categoria });
            } catch (e) {
              console.warn("Ads falhou, mas matéria continua.", e);
            }
          }

          statusEl.textContent = "";
        } catch (e) {
          console.error(e);
          statusEl.textContent = "Falha de rede ao carregar a matéria.";
          materiaEl.innerHTML = "<p>Erro ao carregar a matéria.</p>";
        }
      }

      carregar();
    </script>
  </body>
</html>
